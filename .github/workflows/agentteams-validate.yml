name: agentteams-validate

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  validate-takt-task-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Python deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
      - name: Validate TAKT task schema (Windows)
        shell: pwsh
        run: |
          python scripts/validate-takt-task.py --path .takt/tasks

  validate-takt-task-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
      - name: Validate TAKT task schema (Linux)
        run: |
          python scripts/validate-takt-task.py --path .takt/tasks

  validate-takt-evidence-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
      - name: Validate TAKT evidence
        run: |
          python scripts/validate-takt-evidence.py --allow-empty-logs

  validate-control-plane-schema:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
      - name: Validate control-plane schema
        run: |
          python scripts/validate-control-plane-schema.py --path .takt/control-plane

  validate-intake-pr-paths:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Validate intake path guard
        run: |
          python scripts/validate-intake-pr-paths.py \
            --base-ref "${{ github.event.pull_request.base.sha }}" \
            --head-ref "${{ github.event.pull_request.head.sha }}" \
            --allow-no-intake-changes

  orchestrate-smoke-mock:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
      - name: Install TAKT
        run: |
          npm install -g takt
      - name: Orchestrate smoke test (mock)
        run: |
          python scripts/at.py orchestrate --task-file .takt/tasks/TASK-00140-final-code-review.yaml --provider mock --no-post-validate --verbose

  validate-doc-consistency:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Validate docs and script consistency
        run: |
          python scripts/validate-doc-consistency.py

  validate-secrets-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION="8.24.2"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz gitleaks
          sudo install -m 0755 gitleaks /usr/local/bin/gitleaks
      - name: Validate secrets
        run: |
          bash ./scripts/validate-secrets.sh
