name: fleet-detect-refresh

on:
  push:
    branches:
      - main
    paths:
      - ".takt/control-plane/intake/**"

jobs:
  detect-and-propose-refresh:
    if: vars.AGENTTEAMS_CONTROL_PLANE_ENABLED == 'true' && vars.AGENTTEAMS_CONTROL_PLANE_MODE == 'hub'
    runs-on: ubuntu-latest
    concurrency:
      group: fleet-detect-refresh
      cancel-in-progress: true
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
      - name: Validate control-plane schema
        run: |
          python scripts/validate-control-plane-schema.py --path .takt/control-plane
      - name: Aggregate fleet signals (event-driven)
        run: |
          python scripts/aggregate-fleet-signals.py --control-plane .takt/control-plane --write-history
      - name: Detect recurring fleet incidents
        run: |
          python scripts/detect-fleet-incidents.py \
            --signals .takt/control-plane/signals/latest.yaml \
            --min-projects 3 \
            --output .takt/control-plane/signals/incidents-detected.yaml
      - name: Detect role overload
        run: |
          python scripts/detect-role-overload.py \
            --intake .takt/control-plane/intake \
            --window-days 14 \
            --output .takt/control-plane/signals/overload-detected.yaml
      - name: Generate refresh proposal
        run: |
          python scripts/generate-refresh-pr.py \
            --control-plane .takt/control-plane \
            --incidents .takt/control-plane/signals/incidents-detected.yaml \
            --overload .takt/control-plane/signals/overload-detected.yaml \
            --apply-catalog-updates
      - name: Detect generated changes
        id: detect_changes
        run: |
          if git diff --quiet -- .takt/control-plane .takt/skills; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi
      - name: Create refresh PR
        if: steps.detect_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bot/agentteams-refresh
          delete-branch: true
          commit-message: "chore(control-plane): auto-generate refresh proposal"
          title: "chore: auto-generated AgentTeams refresh proposal"
          body: |
            This PR was generated by event-driven fleet detection.

            - source: control-plane intake update
            - schedule: disabled (event-driven only)
            - required gates: qa_review, leader_gate

            Please review generated queue/proposal and catalog updates.
          labels: |
            automation
            refresh
